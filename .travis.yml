sudo: required
language: python
services:
- docker
script:
- export AWS_SSH_KEY_NAME=ci_cloudpassage_halo-test-environment
- export AWS_REGION=us-west-2
- export ENVIRONMENT_NAME=IntegrationTest_${IMAGE_NAME}
- export HALO_GROUP_TAG=${ENVIRONMENT_NAME}
- export SERVER_COUNT=1
- docker build -t ${IMAGE_NAME} --build-arg CC_TEST_REPORTER_ID=${CC_TEST_REPORTER_ID} .
- docker run -it --rm -e "AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}" -e "AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}"
  -e "ENVIRONMENT_NAME=${IMAGE_NAME}" -e "AMI_ID=${AMI_ID}" -e "AWS_SSH_KEY_NAME=${AWS_SSH_KEY_NAME}"
  -e "AWS_REGION=${AWS_REGION}" -e "HALO_GROUP_TAG=${HALO_GROUP_TAG}" -e "HALO_AGENT_KEY=${HALO_AGENT_KEY}"
  -e "SERVER_COUNT=${SERVER_COUNT}" -e "CLI_CMD=${CLI_CMD}" ${IMAGE_NAME} provision
- sleep 60
- docker run -it --rm -e "AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}" -e "AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}"
  -e "AWS_REGION=${AWS_REGION}" -e "ENVIRONMENT_NAME=${IMAGE_NAME}" ${IMAGE_NAME}
  deprovision
after_failure:
- docker run -it --rm -e "AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}" -e "AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}"
  -e "AWS_REGION=${AWS_REGION}" -e "ENVIRONMENT_NAME=${IMAGE_NAME}" ${IMAGE_NAME}
  deprovision
env:
  matrix:
  - AMI_ID=ami-ba602bc2 CLI_CMD=Cg== IMAGE_NAME=populator-ubu1
  - AMI_ID=ami-28e07e50 CLI_CMD=Cg== IMAGE_NAME=populator-rhel1
  - AMI_ID=ami-ba602bc2 CLI_CMD=IyEvYmluL3NoCgphcHQtZ2V0IHVwZGF0ZSAmJiBhcHQtZ2V0IGluc3RhbGwgYXBhY2hlMgo=
    IMAGE_NAME=populator-ubu2
  - AMI_ID=ami-28e07e50 CLI_CMD=IyEvYmluL3NoCgp5dW0gaW5zdGFsbCBodHRwZAo= IMAGE_NAME=populator-rhel2
  global:
  - secure: HSd9zn371MhlEMvrAQu3zLIqOITYcoKvudwDmomB8hSejq3knKpMnIi3zUOyTA1u/cbl7o/KgXOXVTvnyjntO7BMLBrmS3QIjk3fl8GUvQnX7e/PKFAH/WAI2ZoLIJGgOr8zBIMrk9rH+1V9Meer4H4OaWkemV7aRMMSz77M/FtLR3FKcGO2VsSnqJs+u5wQGLmlEQR/oUESR0CwuDlQbUPKC3y83d56TkILZ6nsUje8Q89WiKPiTNxRh6auwqHv+nyd8UIuBFDHzP17xprDcALoRuygpTjVM021w8duyICLkhLNqam0i+LY+7gEaHV/jnXQKPp1Pw/HoTkoP9Z9oFuX4BA2zQA+uMiSDk2k3P/gBSyuq6srVjIrnbKuW6l3jeGsO7jYyn1c2T5b8/+ypx58rosL+J6ipF87jMO4iSSi5Or2YYJHjls10rCNhRvekW5uk3XS0hs3+9iffiZbJ7f2bg/HbFFPbqHD4C7XVoSUH60sgmaj/Rzgbu8uBK65zGWKqyO0oHtbSf8z+QVPqPphhWP0InBKc3EzbpX1QJ5dQphDBbyL7YSS6ea6DOBHdcNRZiat2VwDv6N/0zN2TivqesECvgM/ho+5uc3RaZA4UF+ZWixAafPaJz/KHA/vqbo+dnEeIwIj0QZdLTcH0Ltj77e5+VJrrbHSmoymkr4=
  - secure: ijyWAzjjbzgB5Kpz6zWOP43g7FGsD6PZXLHQQcpXXZcdqwxzfwSlWoKKoSZpOb6y4a6KbqTjvK/KBhfgGOibaeRriV8dmEz+kAQNGzETTnEFUV80gr0VOLI5ylgdsSL5wJfF8B5WZNTwNQYZZS/T6S1FBNmgeKmBAKaByQF75h8BDkWE92WQ/xpY/Ovm69UkvOFca8pwsOv1OWejXRc5GGdivcELQhHBh6U3rrtzORzhfowxi0c4Yt0avAuuTzZ+6GhnEjL3Xc4z/WgUpTP4wxRZy9LgD6rsjQGT1oyaFqf9CPvqndrXgubfAcrrxuP6Y40ApNnEdeCSpmuYBeL52XNwe9+u8vh79OHQbyLQXoOed5wxHyrNwjwOAv/Y/EyQl/Y92n3wh1ytoWw8XCjaYT0F8PagHTclBjricpxfo8T1rHJZ+sx5HbSq9fumZzEudRcbwXRqKwTu/gtLSmiziCuRJTYoAko7FnzzrQwAxMIHfT5lEhrUA0vSpWNKnq0Dzn4nPUKo+w+mqek0JL79e4JkaHKSSwY3pUbUziTgSHEYcDRDYsAEk899Bh0GHjdRBsHW7j+o9YX8nGL6HECRlFs6hguOaAGl+EE2Wkqk99QcfFTMg07rWiW524fjQ0BnmX+DE5T01FfnsWmbnWQO5LSfP4ZAcV7CVBcnIxHtdC0=
  - secure: M2aTYGz7Im1xoyzv/3MHu+emKj0LdfzIMnnpGKEk5hxrEDinYxaUcYLuQNdM28RulWKo9p2vmu8UErelxDjkasDyvjBeZ8e7o0svMapXVz/22l+MGZgQUR8wXRR5c8nIXUHDM51QwbORWywUxsNKMJZ/0hKyoCN0RC8uNxTVnqfaBhqwjdox+EW49M0xBya09Ouqzabr7bfzSDiPs1I+tpQ83yWlaclP+2z9tG7GFalem/y/J27LuwCxnBJCZY4LmlwjF9Ez8lapFOD2OAdT/SciRJ+xRfK1SjgKkEbrVWwNjTrfTXhS3hFeXpyqC/1W4UeLQL4Wozz1/bOZM5n4lp8xqYZuv4mQn5pOen+YVzHrhs4VyfMDkf9F/NkWO+LQ/d2rsfgc1zx+HIjiEFQjH3P62KaRBr44vzUhk10uJRxXp5IsMJ/vTyd5JOC/p9rRZgb6pQRbjd+eIae/s6MTJcVbnrMXCSduDFvxl+x4HWPjrtDMntKWKLg5FvnAULgUjzVFOtZemS/nznnphIEfPBm5X6IxzBt0j/liG4+OiHoOL0v6NSvVYeTXRGJXOKa5pff7cU77HXNq0TR9n4FJqzM/4lS89Lhohi9IDQwJTeceh0mmcfMrvjr6+pL1FswpZm52/4HBdttSEokGgN1gzu7soGACRrgwFvmvi/NaVTk=
  - secure: gW/JtzbOexb742ZJDc9/RV2ghWnPmQGxcBH0JI6DWvX1FNVLBiEYzqlKclqgpwuLm6Y95z4lR3V2OdFuy9o4z23s5JkW7W/NsUh7ZzBb6fx04NrUtwaj4dujpKx/ol0zvyQpOHXPM+kvATixLIJ+wm/cyqh8n9sYfSRwZfyrBgvLOCBSiCPunjlZ+zqoZmWXj2RKWQUh1NG1J9S86jbnlRcKfovMLvz3cevSsWmZd60K0OmJ7xtZ3DvWGGa/9HDZxH4Qe3ok9/TebHl9B0K6YR2vyWJtP8GVJAVp1vA6KHIdlpBEQesTsWHZtuapXE65fceS0PFa0F5dP/tcWi3COiHoJJzA8UZfbg2N9S5cdyV1FChk0i0+zHyysmRE6qPr35AZieamwNtIW/UZuWGL2Yq8Q8JhiuzAyHK3tbNVn+PzEKeNCvCeIlRTeCfPSFh1rtR8/jpnZGeOu3BBBHS+/1zVqMAmftN9izeRzdramnRfx0dSJPDoLea6ONJsD+XB/peycYSB/K+h6wkVRMSuAshmejOvJswIL/6wAEOB2XDTKPreXS/7v6C70Yi4+6DkDVEYhveRCoNVd61zQFqK+nzmAwR3nkuQ/2T9eBhXPFGfJyXWj9F62FnmzV4qqIynMOu18znTbevvBzOL/VXL0OFeaHcLUh7zsq1CEuvr5aw=
  - secure: kaATM3sSA6QwVfZD0+pXGA2xt4Nmsl/x+CdXUPEUlCaHdXlDZ0i/axXRvcZPkJZUAW0pyB9qTP9DWRfV1GC8T+LWj979lCfrPacEuT61VK42T1Rbh9Z4+l5qcscc8PnYScx6sr7RPTEgJTbGaut+I1td62pkBLKEzmIGM2wXzeXpQbF9sj0I70av5A4NLmd406p8M6cYQYCEFbdK2G89zsk63xoUw8qgm1zmjDx2XZomlwBAphwY1kftWqCfPUCcCauu5/6WYPq2Yc/HYgRJ8c8dfNDqiVQRM60k8Y0FYf2tcKzE7x4OliefVY8ud9vkMbK5Fv2fjNwNivEBkz1TnZgGWfCwMb05inxKgOO6xVxlE3WTtALcrOwTLb3jz3zi9qhI4EvA2SHtzTF5sP2qd3AGygjbNGSxbjovXaYXGhnr7cNTbR/vlsbm4ct30tjRBfgQ10w+81Psl0JcMALXW0R7d/co1TOO3AOP6gG4Ha769dkemus5Q/rvfnVQxHo7jvn3TSfka/eRYH27fC6rtwL9mS5QPNyaDIVjDMRYwxlnfh+3CkfFPmsmnvmCXtO8MMnd0GefBatcMMpzdWslNDR7sU4Qv4xufziWRT9aQ2PiphmS+LMCl/xMz0Xfa2SYwzBv7fpZJvvzg71XecpK5rDfkwa57CnuOe5ZYAPAYvw=
  - secure: buLJMergl3wBjPBarGEf/xfxFVj3jOZ/CT6XJmtAeeku9GQtsPDi3zYIk0pqlXmWw48LovKBP2Sg0I/vO4TLrEDuEPGTc9MQLU1gAxlAtYz6z/aKBi1/0H6v47DCSX93qe6QD5/PAmFEhw/NFKet7RIg9uc7z7monNkUa1a9k1yIOfbIOHuljvsUVuSoMBI260TWepxYrFbd8mguuDQ41hnS+AZ+0hX6432dXcXu5KcaH3Rn08+v51IFqzswXlhExdcPYaeCLt30E6qVSXFC4I4JA/gSLGDxSEijd/Zoz85BCseh2WeDBUZ4zGrLoFVBe7I9VJe1qnZGGPVcG3GH88XvkQ6YDpB3voeEchvsaLh8uul2DAB1MKMitIfhhCZj0YXjCz7uYNTXzB7OqGCNxkWCLVfeCtzI/4CphTfNkpdb0DyYLVWn6C5fhY+5B1w4FdpNH/BfTlgbVL/6KMiyOGLmTPWX9LthwtJSQuQPEo4QoqFqloQOd7WQagUc8uWAyMBKZ1ZvBtV7Wyp3aFTKE36sPzDsJg8dPSPjY3vuRF5Sn6TvJRITV78jf53KfiATWkpU9yWPr1ZzLucz1yvw3l8czEjRI5sdTI3XI2zXPC7mrn0bY6qcu/SppJI8ERL+31CFpU7H2r0EeY2dQa1qouBVkx1PAd94Vs095iB1UDo=
